# Monthly Games - 씬 설계 문서 Part 1: 공통 씬 아키텍처

> 작성일: 2025-12-17
> 버전: v1.0

---

## 목차

1. [씬 시스템 개요](#1-씬-시스템-개요)
2. [공통 씬 타입 정의](#2-공통-씬-타입-정의)
3. [씬 전환 플로우 패턴](#3-씬-전환-플로우-패턴)
4. [씬별 UI 컴포넌트 구조](#4-씬별-ui-컴포넌트-구조)
5. [씬 상태 관리](#5-씬-상태-관리)

---

## 1. 씬 시스템 개요

### 1.1 SceneManager 아키텍처

```dart
// mg-common-game/lib/core/engine/scene_manager.dart
@singleton
class SceneManager {
  final GlobalKey<NavigatorState> navigatorKey;

  // 씬 전환 메서드
  Future<T?> push<T>(Route<T> route);           // 새 씬 푸시
  Future<T?> pushNamed<T>(String routeName);    // 이름으로 푸시
  Future<T?> replace<T, TO>(Route<T> newRoute); // 씬 교체
  void pop<T>([T? result]);                     // 씬 팝
  void popUntil(predicate);                     // 조건까지 팝
}
```

### 1.2 씬 생명주기

```
┌─────────────────────────────────────────────────────────┐
│                    씬 생명주기                           │
├─────────────────────────────────────────────────────────┤
│  onCreate → onLoad → onMount → [Active] → onRemove     │
│                         ↑                    │          │
│                         └────── resume ──────┘          │
│                                                         │
│  상태: initializing → running → paused → stopped        │
└─────────────────────────────────────────────────────────┘
```

### 1.3 씬 스택 구조

```
┌─────────────────────┐
│    PopupScene       │  ← 오버레이 레이어 (팝업, 모달)
├─────────────────────┤
│    ActiveScene      │  ← 활성 씬 (전투, 퍼즐 등)
├─────────────────────┤
│    BaseScene        │  ← 기본 씬 (로비, 메인)
├─────────────────────┤
│    RootScene        │  ← 루트 (스플래시, 로딩)
└─────────────────────┘
```

---

## 2. 공통 씬 타입 정의

### 2.1 필수 씬 (모든 게임 공통)

| 씬 ID | 씬 이름 | 용도 | 우선순위 |
|-------|--------|------|----------|
| `SCN_SPLASH` | 스플래시 씬 | 앱 시작, 로고 표시 | P0 |
| `SCN_LOADING` | 로딩 씬 | 리소스 로드, 진행 표시 | P0 |
| `SCN_TITLE` | 타이틀 씬 | 게임 타이틀, 시작 버튼 | P0 |
| `SCN_LOBBY` | 로비 씬 | 메인 허브, 콘텐츠 진입점 | P0 |
| `SCN_SETTINGS` | 설정 씬 | 게임 설정, 옵션 | P0 |

### 2.2 성장/수집 씬 (대부분 게임 공통)

| 씬 ID | 씬 이름 | 용도 |
|-------|--------|------|
| `SCN_INVENTORY` | 인벤토리 씬 | 아이템/장비 관리 |
| `SCN_CHARACTER` | 캐릭터 씬 | 캐릭터 정보/강화 |
| `SCN_COLLECTION` | 도감 씬 | 수집 도감 |
| `SCN_SHOP` | 상점 씬 | 인게임 상점 |
| `SCN_GACHA` | 가챠 씬 | 뽑기/소환 |

### 2.3 콘텐츠 씬 (장르별)

| 씬 ID | 씬 이름 | 적용 장르 |
|-------|--------|----------|
| `SCN_BATTLE` | 전투 씬 | RPG, 방치형 |
| `SCN_PUZZLE` | 퍼즐 씬 | 퍼즐, 매치3 |
| `SCN_STAGE_SELECT` | 스테이지 선택 | 스테이지 기반 |
| `SCN_WORLD_MAP` | 월드맵 씬 | 탐험형 |
| `SCN_ARENA` | 아레나 씬 | PVP |

### 2.4 소셜/이벤트 씬

| 씬 ID | 씬 이름 | 용도 |
|-------|--------|------|
| `SCN_GUILD` | 길드 씬 | 길드 관리 |
| `SCN_FRIEND` | 친구 씬 | 친구 목록 |
| `SCN_RANKING` | 랭킹 씬 | 순위표 |
| `SCN_EVENT` | 이벤트 씬 | 이벤트 허브 |
| `SCN_MAIL` | 우편함 씬 | 보상 수령 |

---

## 3. 씬 전환 플로우 패턴

### 3.1 기본 플로우: 앱 시작 → 로비

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Splash  │───→│  Loading │───→│  Title   │───→│  Lobby   │
│   씬     │    │    씬    │    │   씬     │    │   씬     │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │
     ▼               ▼               ▼               ▼
  로고 표시      리소스 로드      터치 대기      메인 허브
  2~3초         프로그레스바     BGM 시작      모든 기능
```

### 3.2 게임 플레이 플로우

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Lobby   │───→│  Stage   │───→│  Battle  │───→│  Result  │
│   씬     │    │  Select  │    │   씬     │    │   씬     │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │                                               │
     └───────────────────────────────────────────────┘
                         복귀
```

### 3.3 팝업/모달 플로우

```
┌─────────────────────────────────────┐
│            Active Scene             │
│  ┌───────────────────────────────┐  │
│  │      Popup Overlay            │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │    Modal Content        │  │  │
│  │  │  - 확인 팝업            │  │  │
│  │  │  - 보상 획득            │  │  │
│  │  │  - 설정                 │  │  │
│  │  └─────────────────────────┘  │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 3.4 씬 전환 애니메이션 타입

| 타입 | 사용 상황 | 설명 |
|------|----------|------|
| `fade` | 일반 전환 | 페이드 인/아웃 |
| `slide_left` | 진입 | 왼쪽에서 슬라이드 |
| `slide_right` | 복귀 | 오른쪽에서 슬라이드 |
| `slide_up` | 팝업 | 아래에서 위로 |
| `scale` | 강조 | 스케일 애니메이션 |
| `none` | 즉시 | 애니메이션 없음 |

---

## 4. 씬별 UI 컴포넌트 구조

### 4.1 로비 씬 레이아웃

```
┌─────────────────────────────────────────────────────────┐
│ ┌─────────────────────────────────────────────────────┐ │
│ │  상단 바 (Top Bar)                                   │ │
│ │  [프로필] [레벨] [재화1] [재화2] [재화3] [설정]      │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │                                                     │ │
│ │              메인 콘텐츠 영역                        │ │
│ │         (캐릭터 표시 / 메인 비주얼)                  │ │
│ │                                                     │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  퀵 액세스 버튼                                      │ │
│ │  [우편] [이벤트] [미션] [공지]                       │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  하단 내비게이션 (Bottom Nav)                        │ │
│ │  [홈] [캐릭터] [가챠] [상점] [전투]                  │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 4.2 전투 씬 레이아웃

```
┌─────────────────────────────────────────────────────────┐
│ ┌─────────────────────────────────────────────────────┐ │
│ │  전투 상단 바                                        │ │
│ │  [일시정지] [스테이지명] [웨이브] [타이머] [배속]    │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  적 HP 바                                           │ │
│ │  ████████████░░░░░░ 75%                             │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │                                                     │ │
│ │              전투 필드                               │ │
│ │         (캐릭터 / 적 / 이펙트)                       │ │
│ │                                                     │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  아군 HP/상태                                        │ │
│ │  [캐릭1 HP] [캐릭2 HP] [캐릭3 HP] [캐릭4 HP]        │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  스킬 버튼                                          │ │
│ │  [스킬1] [스킬2] [스킬3] [궁극기]                   │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 4.3 퍼즐 씬 레이아웃

```
┌─────────────────────────────────────────────────────────┐
│ ┌─────────────────────────────────────────────────────┐ │
│ │  퍼즐 상단 바                                        │ │
│ │  [뒤로] [스테이지] [목표] [이동수/시간] [점수]       │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  목표 표시                                          │ │
│ │  [목표1: 0/10] [목표2: 0/5] [목표3: 0/3]            │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  ┌───┬───┬───┬───┬───┬───┬───┐                     │ │
│ │  │   │   │   │   │   │   │   │                     │ │
│ │  ├───┼───┼───┼───┼───┼───┼───┤                     │ │
│ │  │   │   │   │   │   │   │   │  퍼즐 보드          │ │
│ │  ├───┼───┼───┼───┼───┼───┼───┤  (7x7 ~ 9x9)       │ │
│ │  │   │   │   │   │   │   │   │                     │ │
│ │  ├───┼───┼───┼───┼───┼───┼───┤                     │ │
│ │  │   │   │   │   │   │   │   │                     │ │
│ │  └───┴───┴───┴───┴───┴───┴───┘                     │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ ┌─────────────────────────────────────────────────────┐ │
│ │  아이템/부스터                                       │ │
│ │  [셔플] [폭탄] [라인클리어] [색상폭탄]              │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

## 5. 씬 상태 관리

### 5.1 GameManager 상태 머신

```dart
enum GameState {
  initializing,  // 초기화 중
  running,       // 실행 중
  paused,        // 일시정지
  stopped,       // 정지
}

class GameStateChangedEvent {
  final GameState previous;
  final GameState current;
}
```

### 5.2 씬별 상태 저장/복원

```dart
// 씬 전환 시 상태 저장
abstract class SceneState {
  Map<String, dynamic> toJson();
  void fromJson(Map<String, dynamic> json);
}

// 예: 전투 씬 상태
class BattleSceneState extends SceneState {
  int currentWave;
  int playerHP;
  int enemyHP;
  List<SkillCooldown> cooldowns;
}
```

### 5.3 씬 전환 시 이벤트 흐름

```
┌─────────────────────────────────────────────────────────┐
│  SceneA                    SceneB                       │
│    │                         │                          │
│    │── onPause() ──────────→ │                          │
│    │                         │── onCreate() ───────→    │
│    │                         │── onLoad() ─────────→    │
│    │                         │── onMount() ────────→    │
│    │── onRemove() ────────→  │                          │
│    │                         │── [Active] ─────────→    │
└─────────────────────────────────────────────────────────┘
```

### 5.4 백그라운드/포그라운드 처리

```dart
// 앱 생명주기 이벤트 처리
void onAppLifecycleStateChange(AppLifecycleState state) {
  switch (state) {
    case AppLifecycleState.paused:
      // 백그라운드 진입
      _gameManager.pause();
      _saveCurrentState();
      break;
    case AppLifecycleState.resumed:
      // 포그라운드 복귀
      _gameManager.resume();
      _calculateOfflineRewards();
      break;
    case AppLifecycleState.detached:
      // 앱 종료
      _gameManager.stop();
      break;
  }
}
```

---

## 다음 문서

- [Part 2: Year 1 게임별 씬 설계 (0001-0012)](./scene_design_part2_year1.md)
- [Part 3: Year 2 게임별 씬 설계 (0013-0024)](./scene_design_part3_year2.md)
- [Part 4: Level A 게임별 씬 설계 (0025-0036)](./scene_design_part4_level_a.md)
